name: Auto Parse github form - master
run-name: ${{ github.actor }} - issue:${{ github.event.issue.number }}
on:
  issues:
    types:
      - opened
      - edited
      - labeled
  workflow_dispatch:
env:
  GH_TOKEN: ${{ secrets.PLATFORM_USER_TOKEN }}
  GH_REPO: ${{ github.repository }}
  NUMBER: ${{ github.event.issue.number }}
permissions:
  id-token: write

jobs:
  process-request:
    permissions: write-all
    runs-on: ubuntu-latest
    if: github.event.issue.user.login != 'renovate[bot]' && github.actor != 'hmcts-platform-operations' && !contains(github.event.issue.labels.*.name, 'cancel') && !contains(github.event.issue.labels.*.name, 'pull-request')
    steps:
      #Allows workflow to access repo
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: '0'
          # token: ${{ env.GH_TOKEN }}
      #Get issue body
      - name: Get issue body
        id: get_issue_body
        run: |
          gh issue view --repo hmcts/auto-shutdown ${{ github.event.issue.number }} --json body | jq -r '.body' > body.txt
          sed -i "s/'//g" body.txt 
          cat body.txt
        env:
          GH_TOKEN: ${{ github.token }}
      #Create a multiline variable so it can be read by parser
      # - name: multiline github var
      #   run: |
      #     echo 'ISSUE_BODY<<EOF' >> $GITHUB_ENV
      #     while read LINE; do
      #     echo "$LINE" >> $GITHUB_ENV;
      #     done < body.txt
      #     echo 'EOF' >> $GITHUB_ENV
      #     rm body.txt
      # #Parse issue form that trigger workflow
      # - name: Read submitted issue
      #   id: parse_issue
      #   uses: stefanbuck/github-issue-parser@v3.1.1
      #   with:
      #     issue-body: ${{ env.ISSUE_BODY }}
      #     template-path: .github/ISSUE_TEMPLATE/3-skip-auto-shutdown-request.yaml
      # #Save parsed date into environment variables
      # - name: Save parsed jsonString data
      #   run: |
      #     echo '${{ steps.parse_issue.outputs.jsonString }}' > NEW_DATA.json
      #     echo NEW_DATA=$(cat NEW_DATA.json | jq -c | jq '.form_environment |= split(",")') >> $GITHUB_ENV
      #     rm NEW_DATA.json
      #     echo GITHUB_REPO='${{ github.repository }}' >> $GITHUB_ENV
      #     echo ISSUE_NUMBER='${{ github.event.issue.number }}' >> $GITHUB_ENV